#!/bin/bash

base_name="$(basename "$(pwd)")"
timestamp=$(date +%Y-%m-%d_%H-%M-%S)
output_dir=".zip"
output_zip="${output_dir}/${base_name}.${timestamp}.zip"

mkdir -p "$output_dir"

if [ ! -f ".gitignore" ]; then
  echo "Error: .gitignore file not found in the current directory."
  exit 1
fi

if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  echo "Error: Not a git repository. Please initialize with 'git init'."
  exit 1
fi

# true temp file (outside repo)
file_list=$(mktemp)

# only tracked + untracked (not ignored)
git ls-files --cached --others --exclude-standard > "$file_list"

zip -r@ "$output_zip" < "$file_list"

rm "$file_list"

if [ $? -eq 0 ]; then
  echo "Successfully created $output_zip (fully respecting .gitignore patterns)."
else
  echo "Error: Failed to create $output_zip"
  exit 1
fi
